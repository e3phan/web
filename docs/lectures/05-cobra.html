<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Data Representation</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">CSE 131</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
		<a href="../calendar.html">Calendar</a>
                <a href="../grades.html">Grades</a>
                <a href="../assignments.html">Assignments</a>
                <a href="../lectures.html">Lectures</a>
                <a href="../resources.html">Resources</a>
            </div>
        </div>

        <div id="content">
            <h1>Data Representation</h1>

            <p>Next, lets add support for</p>
<ul>
<li><strong>Multiple datatypes</strong> (<code>number</code> and <code>boolean</code>)</li>
<li><strong>Calling</strong> external functions</li>
</ul>
<p>In the process of doing so, we will learn about</p>
<ul>
<li><strong>Tagged Representations</strong></li>
<li><strong>Calling Conventions</strong></li>
</ul>
<h2 id="plan">Plan</h2>
<p>Our plan will be to (start with <code>boa</code>) and add the following features:</p>
<ol type="1">
<li><p><strong>Representing</strong> boolean values (and numbers)</p></li>
<li><p><strong>Arithmetic Operations</strong></p></li>
<li><p><strong>Arithmetic Comparisons</strong></p></li>
<li><p><strong>Dynamic Checking</strong> (to ensure operators are well behaved)</p></li>
</ol>
<h2 id="representation">1. Representation</h2>
<h3 id="motivation-why-booleans">Motivation: Why booleans?</h3>
<p>In the year 2018, its a bit silly to use</p>
<ul>
<li><code>0</code> for <code>false</code> and</li>
<li>non-zero for <code>true</code>.</li>
</ul>
<p>But really, <code>boolean</code> is a stepping stone to other data</p>
<ul>
<li>Pointers,</li>
<li>Tuples,</li>
<li>Structures,</li>
<li>Closures.</li>
</ul>
<h3 id="the-key-issue">The Key Issue</h3>
<p>How to <em>distinguish</em> numbers from booleans?</p>
<ul>
<li>Need to store some <em>extra</em> information to mark values as <code>number</code> or <code>bool</code>.</li>
</ul>
<h3 id="option-1-use-two-words">Option 1: Use <em>Two</em> Words</h3>
<p>First word is <code>0</code> means <code>bool</code>, is <code>1</code> means <code>number</code>, <code>2</code> means pointer etc.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Value</th>
<th style="text-align: right;">Representation (HEX)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>3</code></td>
<td style="text-align: right;"><code>[0x000000000][0x00000003]</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>5</code></td>
<td style="text-align: right;"><code>[0x000000000][0x00000005]</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>12</code></td>
<td style="text-align: right;"><code>[0x000000000][0x0000000c]</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>42</code></td>
<td style="text-align: right;"><code>[0x000000000][0x0000002a]</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>false</code></td>
<td style="text-align: right;"><code>[0x000000001][0x00000000]</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>true</code></td>
<td style="text-align: right;"><code>[0x000000001][0x00000001]</code></td>
</tr>
</tbody>
</table>
<p>Pros</p>
<ul>
<li>Can have <em>lots</em> of different types, but</li>
</ul>
<p>Cons</p>
<ul>
<li>Takes up <em>double</em> memory,</li>
<li>Operators <code>+</code>, <code>-</code> do <em>two</em> memory reads <code>[eax]</code>, <code>[eax - 4]</code>.</li>
</ul>
<p>In short, rather wasteful. Don’t need <em>so many</em> types.</p>
<h3 id="option-2-use-a-tag-bit">Option 2: Use a <em>Tag Bit</em></h3>
<p>Can distinguish <em>two</em> types with a <em>single bit</em>.</p>
<p><em>Least Significant Bit</em> (LSB) is</p>
<ul>
<li><code>0</code> for <code>number</code></li>
<li><code>1</code> for <code>boolean</code></li>
</ul>
<p>(Hmm, why not <code>0</code> for <code>boolean</code> and <code>1</code> for <code>number</code>?)</p>
<h3 id="tag-bit-numbers">Tag Bit: Numbers</h3>
<p>So <code>number</code> is the binary representation shifted left by 1 bit</p>
<ul>
<li>Lowest bit is always <code>0</code></li>
<li>Remaining bits are number’s binary representation</li>
</ul>
<p>For example,</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Value</th>
<th style="text-align: right;">Representation (Binary)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>3</code></td>
<td style="text-align: right;"><code>[0b00000000000000000000000000000110]</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>5</code></td>
<td style="text-align: right;"><code>[0b00000000000000000000000000001010]</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>12</code></td>
<td style="text-align: right;"><code>[0b00000000000000000000000000011000]</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>42</code></td>
<td style="text-align: right;"><code>[0b00000000000000000000000001010100]</code></td>
</tr>
</tbody>
</table>
<p>Or in HEX,</p>
<table>
<thead>
<tr class="header">
<th>Value</th>
<th>Representation (HEX)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>3</code></td>
<td><code>[0x00000006]</code></td>
</tr>
<tr class="even">
<td><code>5</code></td>
<td><code>[0x0000000a]</code></td>
</tr>
<tr class="odd">
<td><code>12</code></td>
<td><code>[0x00000018]</code></td>
</tr>
<tr class="even">
<td><code>42</code></td>
<td><code>[0x00000054]</code></td>
</tr>
</tbody>
</table>
<h3 id="tag-bit-booleans">Tag Bit: Booleans</h3>
<p><em>Most Significant Bit</em> (MSB) is</p>
<ul>
<li><code>1</code> for <code>true</code></li>
<li><code>0</code> for <code>false</code></li>
</ul>
<p>For example</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Value</th>
<th style="text-align: right;">Representation (Binary)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>true</code></td>
<td style="text-align: right;"><code>[0b10000000000000000000000000000001]</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>false</code></td>
<td style="text-align: right;"><code>[0b00000000000000000000000000000001]</code></td>
</tr>
</tbody>
</table>
<p>Or, in HEX</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Value</th>
<th style="text-align: right;">Representation (HEX)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>true</code></td>
<td style="text-align: right;"><code>[0x80000001]</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>false</code></td>
<td style="text-align: right;"><code>[0x00000001]</code></td>
</tr>
</tbody>
</table>
<h3 id="types">Types</h3>
<p>Lets extend our source types with <code>boolean</code> constants</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">data</span> <span class="dt">Expr</span> a</a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="fu">|</span> <span class="dt">Boolean</span> <span class="dt">Bool</span> a</a></code></pre></div>
<p>Correspondingly, we extend our assembly <code>Arg</code> (values) with</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">data</span> <span class="dt">Arg</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="fu">|</span> <span class="dt">HexConst</span>  <span class="dt">Int</span></a></code></pre></div>
<p>So, our examples become:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Value</th>
<th style="text-align: right;">Representation (HEX)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>Boolean False</code></td>
<td style="text-align: right;"><code>HexConst 0x00000001</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>Boolean True</code></td>
<td style="text-align: right;"><code>HexConst 0x80000001</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>Number 3</code></td>
<td style="text-align: right;"><code>HexConst 0x00000006</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>Number 5</code></td>
<td style="text-align: right;"><code>HexConst 0x0000000a</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>Number 12</code></td>
<td style="text-align: right;"><code>HexConst 0x0000000c</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>Number 42</code></td>
<td style="text-align: right;"><code>HexConst 0x0000002a</code></td>
</tr>
</tbody>
</table>
<h3 id="transforms">Transforms</h3>
<p>Next, lets update our implementation</p>
<figure>
<img src="../static/img/compiler-pipeline-representation.png" alt="Compiler Pipeline" /><figcaption>Compiler Pipeline</figcaption>
</figure>
<p>The <code>parse</code>, <code>anf</code> and <code>tag</code> stages are straightforward.</p>
<p>Lets focus on the <code>compile</code> function.</p>
<h4 id="a-typeclass-for-representing-constants">A TypeClass for Representing Constants</h4>
<p>Its convenient to introduce a type class describing Haskell types that can be <em>represented</em> as x86 arguments:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">class</span> <span class="dt">Repr</span> a <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="ot">  repr ::</span> a <span class="ot">-&gt;</span> <span class="dt">Arg</span></a></code></pre></div>
<p>We can now define instances for <code>Int</code> and <code>Bool</code> as:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">instance</span> <span class="dt">Repr</span> <span class="dt">Int</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-2" title="2">  repr n <span class="fu">=</span> <span class="dt">Const</span> (Data.Bits.shift n <span class="dv">1</span>) <span class="co">-- left-shift `n` by 1</span></a>
<a class="sourceLine" id="cb4-3" title="3"></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">instance</span> <span class="dt">Repr</span> <span class="dt">Bool</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-5" title="5">  repr <span class="dt">False</span> <span class="fu">=</span> <span class="dt">HexConst</span> <span class="bn">0x00000001</span></a>
<a class="sourceLine" id="cb4-6" title="6">  repr <span class="dt">True</span>  <span class="fu">=</span> <span class="dt">HexConst</span> <span class="bn">0x80000001</span></a></code></pre></div>
<h4 id="immediate-values-to-arguments">Immediate Values to Arguments</h4>
<p><code>Boolean b</code> is an <em>immediate</em> value (like <code>Number n</code>).</p>
<p>Lets extend <code>immArg</code> that tranforms an immediate expression to an x86 argument.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="ot">immArg ::</span> <span class="dt">Env</span> <span class="ot">-&gt;</span> <span class="dt">ImmTag</span> <span class="ot">-&gt;</span> <span class="dt">Arg</span></a>
<a class="sourceLine" id="cb5-2" title="2">immArg (<span class="dt">Var</span>    x _)  <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb5-3" title="3">immArg (<span class="dt">Number</span> n _)  <span class="fu">=</span> repr n</a>
<a class="sourceLine" id="cb5-4" title="4">immArg (<span class="dt">Boolean</span> b _) <span class="fu">=</span> repr b</a></code></pre></div>
<h4 id="compiling-constants">Compiling Constants</h4>
<p>Finally, we can easily update the <code>compile</code> function as:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="ot">compileEnv ::</span> <span class="dt">Env</span> <span class="ot">-&gt;</span> <span class="dt">AnfTagE</span> <span class="ot">-&gt;</span> <span class="dt">Asm</span></a>
<a class="sourceLine" id="cb6-2" title="2">compileEnv _ e<span class="fu">@</span>(<span class="dt">Number</span> _ _)  <span class="fu">=</span> [<span class="dt">IMov</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env e)]</a>
<a class="sourceLine" id="cb6-3" title="3">compileEnv _ e<span class="fu">@</span>(<span class="dt">Boolean</span> _ _) <span class="fu">=</span> [<span class="dt">IMov</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env e)]</a></code></pre></div>
<p>(The other cases remain unchanged.)</p>
<p>Lets run some tests to double check.</p>
<h3 id="quiz">QUIZ</h3>
<p>What is the result of:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1">ghci<span class="fu">&gt;</span> exec <span class="st">&quot;15&quot;</span></a></code></pre></div>
<ul>
<li><strong>A</strong> Error</li>
<li><strong>B</strong> <code>0</code></li>
<li><strong>C</strong> <code>15</code></li>
<li><strong>D</strong> <code>30</code></li>
</ul>
<h3 id="output-representation">Output Representation</h3>
<p>Say what?! Ah. Need to update our run-time printer in <code>main.c</code></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb8-1" title="1"><span class="dt">void</span> print(<span class="dt">int</span> val){</a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="cf">if</span> (val == CONST_TRUE)</a>
<a class="sourceLine" id="cb8-3" title="3">    printf(<span class="st">&quot;true&quot;</span>);</a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="cf">else</span> <span class="cf">if</span> (val == CONST_FALSE)</a>
<a class="sourceLine" id="cb8-5" title="5">    printf(<span class="st">&quot;false&quot;</span>);</a>
<a class="sourceLine" id="cb8-6" title="6">  <span class="cf">else</span> <span class="co">// should be a number!</span></a>
<a class="sourceLine" id="cb8-7" title="7">    printf(<span class="st">&quot;%d&quot;</span>, d &gt;&gt; <span class="dv">1</span>);  <span class="co">// shift right to remove tag bit.</span></a>
<a class="sourceLine" id="cb8-8" title="8">}</a></code></pre></div>
<p>and now we get:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1">ghci<span class="fu">&gt;</span> exec <span class="st">&quot;15&quot;</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="dv">15</span></a></code></pre></div>
<p>Can you think of some other tests we should write?</p>
<h3 id="quiz-1">QUIZ</h3>
<p>What is the result of</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1">ghci<span class="fu">&gt;</span> exec <span class="st">&quot;let x = 15 in x&quot;</span></a></code></pre></div>
<ul>
<li><strong>A</strong> Error</li>
<li><strong>B</strong> <code>0</code></li>
<li><strong>C</strong> <code>15</code></li>
<li><strong>D</strong> <code>30</code></li>
</ul>
<h3 id="quiz-2">QUIZ</h3>
<p>What is the result of</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1">ghci<span class="fu">&gt;</span> exec <span class="st">&quot;if 3: 12 else: 49&quot;</span></a></code></pre></div>
<ul>
<li><strong>A</strong> Error</li>
<li><strong>B</strong> <code>0</code></li>
<li><strong>C</strong> <code>12</code></li>
<li><strong>D</strong> <code>49</code></li>
</ul>
<h2 id="arithmetic-operations">2. Arithmetic Operations</h2>
<p>Constants like <code>2</code>, <code>29</code>, <code>false</code> are only useful if we can perform computations with them.</p>
<p>First lets see what happens with our arithmetic operators.</p>
<h3 id="quiz-addition">QUIZ: Addition</h3>
<p>What will be the result of:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1">ghci<span class="fu">&gt;</span> exec <span class="st">&quot;12 + 4&quot;</span></a></code></pre></div>
<ol type="1">
<li>Does not compile</li>
<li>Run-time error (e.g. segmentation fault)</li>
<li><code>16</code></li>
<li><code>32</code></li>
<li><code>0</code></li>
</ol>
<h3 id="shifted-representation-and-addition">Shifted Representation and Addition</h3>
<p>We are <em>representing</em> a number <code>n</code> by <strong>shifting it left by 1</strong></p>
<blockquote>
<p><code>n</code> has the machine representation <code>2*n</code></p>
</blockquote>
<p>Thus, our <em>source values</em> have the following _representations:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Source Value</th>
<th style="text-align: right;">Representation (DEC)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>3</code></td>
<td style="text-align: right;"><code>6</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>5</code></td>
<td style="text-align: right;"><code>10</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>3 + 5 = 8</code></td>
<td style="text-align: right;"><code>6 + 10 = 16</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>n1 + n2</code></td>
<td style="text-align: right;"><code>2*n1 + 2*n2 = 2*(n1 + n2)</code></td>
</tr>
</tbody>
</table>
<p>That is, <em>addition</em> (and similarly, <em>subtraction</em>) works <em>as is</em> with the shifted representation.</p>
<h3 id="quiz-multiplication">QUIZ: Multiplication</h3>
<p>What will be the result (using our code so far) of:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1">ghci<span class="fu">&gt;</span> exec <span class="st">&quot;12 * 4&quot;</span></a></code></pre></div>
<ol type="1">
<li>Does not compile</li>
<li>Run-time error (e.g. segmentation fault)</li>
<li><code>24</code></li>
<li><code>48</code></li>
<li><code>96</code></li>
</ol>
<p>Hmm. What happened?</p>
<h3 id="shifted-representation-and-multiplication">Shifted Representation and Multiplication</h3>
<p>We are <em>representing</em> a number <code>n</code> by <strong>shifting it left by 1</strong></p>
<blockquote>
<p><code>n</code> has the machine representation <code>2*n</code></p>
</blockquote>
<p>Thus, our <em>source values</em> have the following _representations:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Source Value</th>
<th style="text-align: right;">Representation (DEC)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>3</code></td>
<td style="text-align: right;"><code>6</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>5</code></td>
<td style="text-align: right;"><code>10</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>3 * 5 = 15</code></td>
<td style="text-align: right;"><code>6 * 10 = 60</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>n1 * n2</code></td>
<td style="text-align: right;"><code>2*n1 * 2*n2 = 4*(n1 + n2)</code></td>
</tr>
</tbody>
</table>
<p>Thus, multiplication ends up accumulating the factor of 2. * Result is <em>two times</em> the desired one.</p>
<h3 id="strategy">Strategy</h3>
<p>Thus, our strategy for compiling arithmetic operations is simply:</p>
<ul>
<li>Addition and Subtraction “just work” as before, as shifting “cancels out”,</li>
<li>Multiplication result must be “adjusted” by dividing-by-two
<ul>
<li>i.e. <strong>right shifting by 1</strong></li>
</ul></li>
</ul>
<h3 id="types-1">Types</h3>
<p>The <em>source</em> language does not change at all, for the <code>Asm</code> lets add a “right shift” instruction (<code>shr</code>):</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">data</span> <span class="dt">Instruction</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="fu">|</span> <span class="dt">IShr</span>    <span class="dt">Arg</span>   <span class="dt">Arg</span></a></code></pre></div>
<h3 id="transforms-1">Transforms</h3>
<p>We need only modify <code>compileEnv</code> to account for the “fixing up”</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1"><span class="ot">compileEnv ::</span> <span class="dt">Env</span> <span class="ot">-&gt;</span> <span class="dt">AnfTagE</span> <span class="ot">-&gt;</span> [<span class="dt">Instruction</span>]</a>
<a class="sourceLine" id="cb15-2" title="2">compileEnv env (<span class="dt">Prim2</span> o v1 v2 _) <span class="fu">=</span> compilePrim2 env o v1 v2</a></code></pre></div>
<p>where the helper <code>compilePrim2</code> works for <code>Prim2</code> (binary) operators and <em>immediate arguments</em>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" title="1"><span class="ot">compilePrim2 ::</span> <span class="dt">Env</span> <span class="ot">-&gt;</span> <span class="dt">Prim2</span> <span class="ot">-&gt;</span> <span class="dt">ImmE</span> <span class="ot">-&gt;</span> <span class="dt">ImmE</span> <span class="ot">-&gt;</span> [<span class="dt">Instruction</span>]</a>
<a class="sourceLine" id="cb16-2" title="2">compilePrim2 env <span class="dt">Plus</span> v1 v2   <span class="fu">=</span> [ <span class="dt">IMov</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v1)</a>
<a class="sourceLine" id="cb16-3" title="3">                                , <span class="dt">IAdd</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v2)</a>
<a class="sourceLine" id="cb16-4" title="4">                                ]</a>
<a class="sourceLine" id="cb16-5" title="5">compilePrim2 env <span class="dt">Minus</span> v1 v2  <span class="fu">=</span> [ <span class="dt">IMov</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v1)</a>
<a class="sourceLine" id="cb16-6" title="6">                                , <span class="dt">ISub</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v2)</a>
<a class="sourceLine" id="cb16-7" title="7">                                ]</a>
<a class="sourceLine" id="cb16-8" title="8">compilePrim2 env <span class="dt">Times</span> v1 v2  <span class="fu">=</span> [ <span class="dt">IMov</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v1)</a>
<a class="sourceLine" id="cb16-9" title="9">                                , <span class="dt">IMul</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v2)</a>
<a class="sourceLine" id="cb16-10" title="10">                                , <span class="dt">IShr</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (<span class="dt">Const</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb16-11" title="11">                                ]</a></code></pre></div>
<h3 id="tests">Tests</h3>
<p>Lets take it out for a drive.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" title="1">ghci<span class="fu">&gt;</span> exec <span class="st">&quot;2 * (-1)&quot;</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="dv">2147483644</span></a></code></pre></div>
<p>Whoa?!</p>
<p>Well, its easy to figure out if you look at the generated assembly:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode nasm"><code class="sourceCode nasm"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">mov</span> <span class="kw">eax</span>, <span class="dv">4</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="kw">imul</span> <span class="kw">eax</span>, <span class="dv">-2</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="kw">shr</span> <span class="kw">eax</span>, <span class="dv">1</span></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="kw">ret</span></a></code></pre></div>
<p>The trouble is that the <strong>negative</strong> result of the multiplication is saved in <strong>twos-complement</strong> format, and when we shift that right by one bit, we get the wierd value (<strong>does not “divide by two”</strong>)</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Decimal</th>
<th style="text-align: right;">Hexadecimal</th>
<th style="text-align: right;">Binary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>-8</code></td>
<td style="text-align: right;"><code>0xFFFFFFF8</code></td>
<td style="text-align: right;"><code>0b11111111111111111111111111111000</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>2147483644</code></td>
<td style="text-align: right;"><code>0x7FFFFFFC</code></td>
<td style="text-align: right;"><code>0b01111111111111111111111111111100</code></td>
</tr>
</tbody>
</table>
<p><strong>Solution: Signed/Arithmetic Shift</strong></p>
<p>The instruction <code>sar</code> <a href="https://en.wikibooks.org/wiki/X86_Assembly/Shift_and_Rotate#Arithmetic_Shift_Instructions">shift arithmetic right</a> does what we want, namely:</p>
<ul>
<li>preserves the sign-bit when shifting</li>
<li>i.e. doesn’t introduce a <code>0</code> by default</li>
</ul>
<h3 id="transforms-revisited">Transforms Revisited</h3>
<p>Lets add <code>sar</code> to our target:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">data</span> <span class="dt">Instruction</span></a>
<a class="sourceLine" id="cb19-2" title="2">  <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb19-3" title="3">  <span class="fu">|</span> <span class="dt">ISar</span> <span class="dt">Arg</span> <span class="dt">Arg</span></a></code></pre></div>
<p>and use it to fix the post-multiplication adjustment</p>
<ul>
<li>i.e. use <code>ISar</code> instead of <code>IShr</code></li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" title="1">compilePrim2 env <span class="dt">Times</span> v1 v2  <span class="fu">=</span> [ <span class="dt">IMov</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v1)</a>
<a class="sourceLine" id="cb20-2" title="2">                                , <span class="dt">IMul</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v2)</a>
<a class="sourceLine" id="cb20-3" title="3">                                , <span class="dt">ISar</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (<span class="dt">Const</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb20-4" title="4">                                ]</a></code></pre></div>
<p>After which all is well:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" title="1">ghci<span class="fu">&gt;</span> exec <span class="st">&quot;2 * (-1)&quot;</span></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="fu">-</span><span class="dv">2</span></a></code></pre></div>
<h2 id="arithmetic-comparisons">3. Arithmetic Comparisons</h2>
<p>Next, lets try to implement comparisons:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" title="1">ghci<span class="fu">&gt;</span> exec <span class="st">&quot;1 &lt; 2&quot;</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="fu">...</span></a>
<a class="sourceLine" id="cb22-3" title="3">boa<span class="fu">:</span> lib<span class="fu">/</span><span class="dt">Language</span><span class="fu">/</span><span class="dt">Boa</span><span class="fu">/</span>Compiler.hs<span class="fu">:</span>(<span class="dv">104</span>,<span class="dv">1</span>)<span class="fu">-</span>(<span class="dv">106</span>,<span class="dv">43</span>)<span class="fu">:</span> <span class="dt">Non</span><span class="fu">-</span>exhaustive patterns <span class="kw">in</span> function compilePrim2</a></code></pre></div>
<p>Oops. Need to implement it first!</p>
<p>Many ways to do this:</p>
<ul>
<li>branches <code>jne, jl, jg</code> or</li>
<li>bit-twiddling.</li>
</ul>
<h3 id="comparisons-via-bit-twiddling">Comparisons via Bit-Twiddling</h3>
<p><strong>Key idea:</strong></p>
<blockquote>
<p>A <em>negative</em> number’s <strong>most significant bit</strong> is <code>1</code></p>
</blockquote>
<p>To implement <code>arg1 &lt; arg2</code>, compute <code>arg1 - arg2</code> * When result is negative, MSB is <code>1</code>, ensure <code>eax</code> set to <code>0x80000001</code> * When result is non-negative, MSB is <code>0</code>, ensure <code>eax</code> set to <code>0x00000001</code></p>
<ol type="1">
<li>Can <strong>extract msb</strong> by bitwise <code>and</code> with <code>0x80000000</code>.</li>
<li>Can <strong>set tag bit</strong> by bitwise <code>or</code> with <code>0x00000001</code></li>
</ol>
<p>So compilation strategy is:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode nasm"><code class="sourceCode nasm"><a class="sourceLine" id="cb23-1" title="1"><span class="kw">mov</span> <span class="kw">eax</span>, arg1</a>
<a class="sourceLine" id="cb23-2" title="2"><span class="kw">sub</span> <span class="kw">eax</span>, arg2</a>
<a class="sourceLine" id="cb23-3" title="3"><span class="kw">and</span> <span class="kw">eax</span><span class="bn">, 0x80000000   </span><span class="co">; mask out &quot;sign&quot; bit (msb)</span></a>
<a class="sourceLine" id="cb23-4" title="4"><span class="kw">or</span>  <span class="kw">eax</span><span class="bn">, 0x00000001   </span><span class="co">; set tag bit to bool</span></a></code></pre></div>
<h3 id="comparisons-implementation">Comparisons: Implementation</h3>
<p>Lets go and extend:</p>
<ol type="1">
<li>The <code>Instruction</code> type</li>
</ol>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" title="1"><span class="kw">data</span> <span class="dt">Instruction</span></a>
<a class="sourceLine" id="cb24-2" title="2">  <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb24-3" title="3">  <span class="fu">|</span> <span class="dt">IAnd</span>    <span class="dt">Arg</span>   <span class="dt">Arg</span></a>
<a class="sourceLine" id="cb24-4" title="4">  <span class="fu">|</span> <span class="dt">IOr</span>     <span class="dt">Arg</span>   <span class="dt">Arg</span></a></code></pre></div>
<ol start="2" type="1">
<li>The <code>instrAsm</code> converter</li>
</ol>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb25-1" title="1"><span class="ot">instrAsm ::</span> <span class="dt">Instruction</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb25-2" title="2">instrAsm (<span class="dt">IAnd</span> a1 a2) <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb25-3" title="3">instrAsm (<span class="dt">IOr</span>  a1 a2) <span class="fu">=</span> <span class="fu">...</span></a></code></pre></div>
<ol start="3" type="1">
<li>The actual <code>compilePrim2</code> function</li>
</ol>
<h3 id="exercise-comparisons-via-bit-twiddling">Exercise: Comparisons via Bit-Twiddling</h3>
<ul>
<li>Can compute <code>arg1 &gt; arg2</code> by computing <code>arg2 &lt; arg1</code>.</li>
<li>Can compute <code>arg1 != arg2</code> by computing <code>arg1 &lt; arg2 || arg2 &lt; arg1</code></li>
<li>Can compute <code>arg1 = arg2</code> by computing <code>! (arg1 != arg2)</code></li>
</ul>
<p>For the above, can you figure out how to implement:</p>
<ol type="1">
<li>Boolean <code>!</code> ?</li>
<li>Boolean <code>||</code> ?</li>
<li>Boolean <code>&amp;&amp;</code> ?</li>
</ol>
<p>You may find <a href="https://en.wikibooks.org/wiki/X86_Assembly/Logic">these instructions useful</a></p>
<h2 id="dynamic-checking">4. Dynamic Checking</h2>
<p>We’ve added support for <code>Number</code> and <code>Boolean</code> but we have no way to ensure that we don’t write gibberish programs like:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb26-1" title="1"><span class="dv">2</span> <span class="fu">+</span> true</a></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb27-1" title="1"><span class="dv">7</span> <span class="fu">&lt;</span> false</a></code></pre></div>
<p>In fact, lets try to see what happens with our code on the above:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb28-1" title="1">ghci<span class="fu">&gt;</span> exec <span class="st">&quot;2 + true&quot;</span></a></code></pre></div>
<p>Oops.</p>
<h3 id="checking-tags-at-run-time">Checking Tags at Run-Time</h3>
<p>Later, we will look into adding a <em>static</em> type system that will reject such meaningless programs at <em>compile</em> time. For now, lets see how to extend the compilation to <em>abort execution</em> when the wrong <em>types of operands</em> are found when the code is <em>executing</em>.</p>
<p>The following table lists the types of operands that <em>should be</em> allowed for each primitive operation.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">Operation</th>
<th style="text-align: right;">Op-1</th>
<th style="text-align: right;">Op-2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><code>+</code></td>
<td style="text-align: right;"><code>int</code></td>
<td style="text-align: right;"><code>int</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>-</code></td>
<td style="text-align: right;"><code>int</code></td>
<td style="text-align: right;"><code>int</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>*</code></td>
<td style="text-align: right;"><code>int</code></td>
<td style="text-align: right;"><code>int</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>&lt;</code></td>
<td style="text-align: right;"><code>int</code></td>
<td style="text-align: right;"><code>int</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>&gt;</code></td>
<td style="text-align: right;"><code>int</code></td>
<td style="text-align: right;"><code>int</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>&amp;&amp;</code></td>
<td style="text-align: right;"><code>bool</code></td>
<td style="text-align: right;"><code>bool</code></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>||</code></td>
<td style="text-align: right;"><code>bool</code></td>
<td style="text-align: right;"><code>bool</code></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>!</code></td>
<td style="text-align: right;"><code>bool</code></td>
<td style="text-align: right;"></td>
</tr>
<tr class="odd">
<td style="text-align: right;"><code>if</code></td>
<td style="text-align: right;"><code>bool</code></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: right;"><code>=</code></td>
<td style="text-align: right;"><code>int</code> or <code>bool</code></td>
<td style="text-align: right;"><code>int</code> or <code>bool</code></td>
</tr>
</tbody>
</table>
<h3 id="strategy-1">Strategy</h3>
<p>Lets check that the data in <code>eax</code> is an <code>int</code> * Suffices to check that the LSB is <code>0</code> * If not, jump to special <code>error_non_int</code> label</p>
<p>For example, to check if <code>arg</code> is a <code>Number</code></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode nasm"><code class="sourceCode nasm"><a class="sourceLine" id="cb29-1" title="1"><span class="kw">mov</span> <span class="kw">eax</span>, arg</a>
<a class="sourceLine" id="cb29-2" title="2"><span class="kw">mov</span> <span class="kw">ebx</span>, <span class="kw">eax</span>              <span class="co">; copy into ebx register</span></a>
<a class="sourceLine" id="cb29-3" title="3"><span class="kw">and</span> <span class="kw">ebx</span><span class="bn">, 0x00000001       </span><span class="co">; extract lsb</span></a>
<a class="sourceLine" id="cb29-4" title="4"><span class="kw">cmp</span> <span class="kw">ebx</span>, <span class="dv">0</span>                <span class="co">; check if lsb equals 0</span></a>
<a class="sourceLine" id="cb29-5" title="5"><span class="kw">jne</span> error_non_number      </a>
<a class="sourceLine" id="cb29-6" title="6">...</a></code></pre></div>
<p>at <code>error_non_number</code> we can call into a <code>C</code> function:</p>
<pre><code>error_non_number:
  push eax                ; pass erroneous value
  push 0                  ; pass error code
  call error              ; call run-time &quot;error&quot; function</code></pre>
<p>Finally, the <code>error</code> function is part of the <em>run-time</em> and looks like:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb31-1" title="1"><span class="dt">void</span> error(<span class="dt">int</span> code, <span class="dt">int</span> v){</a>
<a class="sourceLine" id="cb31-2" title="2">   <span class="cf">if</span> (code == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb31-3" title="3">     fprintf(stderr, <span class="st">&quot;Error: expected a number but got %#010x</span><span class="sc">\n</span><span class="st">&quot;</span>, v);</a>
<a class="sourceLine" id="cb31-4" title="4">   }</a>
<a class="sourceLine" id="cb31-5" title="5">   <span class="cf">else</span> <span class="cf">if</span> (code == <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb31-6" title="6">     <span class="co">// print out message for errorcode 1 ...</span></a>
<a class="sourceLine" id="cb31-7" title="7">   }</a>
<a class="sourceLine" id="cb31-8" title="8">   <span class="cf">else</span> <span class="cf">if</span> (code == <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb31-9" title="9">     <span class="co">// print out message for errorcode 2 ...</span></a>
<a class="sourceLine" id="cb31-10" title="10">   } ...</a>
<a class="sourceLine" id="cb31-11" title="11">   exit(<span class="dv">1</span>);</a>
<a class="sourceLine" id="cb31-12" title="12"> }</a></code></pre></div>
<h3 id="strategy-by-example">Strategy By Example</h3>
<p>Lets implement the above in a simple file <code>tests/output/int-check.s</code></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode nasm"><code class="sourceCode nasm"><a class="sourceLine" id="cb32-1" title="1"><span class="kw">section</span> .text</a>
<a class="sourceLine" id="cb32-2" title="2"><span class="kw">extern</span> error</a>
<a class="sourceLine" id="cb32-3" title="3"><span class="kw">extern</span> print</a>
<a class="sourceLine" id="cb32-4" title="4"><span class="kw">global</span> our_code_starts_here</a>
<a class="sourceLine" id="cb32-5" title="5"><span class="fu">our_code_starts_here:</span></a>
<a class="sourceLine" id="cb32-6" title="6">  <span class="kw">mov</span> <span class="kw">eax</span>, <span class="dv">1</span>                <span class="co">; not a valid number</span></a>
<a class="sourceLine" id="cb32-7" title="7">  <span class="kw">mov</span> <span class="kw">ebx</span>, <span class="kw">eax</span>              <span class="co">; copy into ebx register</span></a>
<a class="sourceLine" id="cb32-8" title="8">  <span class="kw">and</span> <span class="kw">ebx</span><span class="bn">, 0x00000001       </span><span class="co">; extract lsb</span></a>
<a class="sourceLine" id="cb32-9" title="9">  <span class="kw">cmp</span> <span class="kw">ebx</span>, <span class="dv">0</span>                <span class="co">; check if lsb equals 0</span></a>
<a class="sourceLine" id="cb32-10" title="10">  <span class="kw">jne</span> error_non_number      </a>
<a class="sourceLine" id="cb32-11" title="11"><span class="fu">error_non_number:</span></a>
<a class="sourceLine" id="cb32-12" title="12">  <span class="kw">push</span> <span class="kw">eax</span></a>
<a class="sourceLine" id="cb32-13" title="13">  <span class="kw">push</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb32-14" title="14">  <span class="kw">call</span> error</a></code></pre></div>
<p>Alas</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb33-1" title="1"><span class="fu">make</span> tests/output/int-check.result</a>
<a class="sourceLine" id="cb33-2" title="2"><span class="ex">...</span> segmentation fault ...</a></code></pre></div>
<p>What happened ?</p>
<h3 id="managing-the-call-stack">Managing the Call Stack</h3>
<p>To properly call into C functions (like <code>error</code>), we must play by the rules of the <a href="http://www.cs.virginia.edu/~evans/cs216/guides/x86.html#calling">C calling convention</a></p>
<figure>
<img src="../static/img/stack-frames.png" alt="Stack Frames" /><figcaption>Stack Frames</figcaption>
</figure>
<ol type="1">
<li>The <em>local variables</em> of an (executing) function are saved in its <em>stack frame</em>.</li>
<li>The <em>start</em> of the stack frame is saved in register <code>ebp</code>,</li>
<li>The <em>start</em> of the <em>next</em> frame is saved in register <code>esp</code>.</li>
</ol>
<h3 id="calling-convention">Calling Convention</h3>
<p>We must <strong>preserve the above invariant</strong> as follows:</p>
<h4 id="in-the-callee">In the Callee</h4>
<p>At the <strong>start</strong> of the function</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode nasm"><code class="sourceCode nasm"><a class="sourceLine" id="cb34-1" title="1"><span class="kw">push</span> <span class="kw">ebp</span>          <span class="co">; save (previous, caller's) ebp on stack</span></a>
<a class="sourceLine" id="cb34-2" title="2"><span class="kw">mov</span> <span class="kw">ebp</span>, <span class="kw">esp</span>      <span class="co">; make current esp the new ebp</span></a>
<a class="sourceLine" id="cb34-3" title="3"><span class="kw">sub</span> <span class="kw">esp</span>, <span class="dv">4</span>*N      <span class="co">; &quot;allocate space&quot; for N local variables</span></a></code></pre></div>
<p>At the <strong>end</strong> of the function</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode nasm"><code class="sourceCode nasm"><a class="sourceLine" id="cb35-1" title="1"><span class="kw">mov</span> <span class="kw">esp</span>, <span class="kw">ebp</span>      <span class="co">; restore value of esp to that just before call</span></a>
<a class="sourceLine" id="cb35-2" title="2">                  <span class="co">; now, value at [esp] is caller's (saved) ebp</span></a>
<a class="sourceLine" id="cb35-3" title="3"><span class="kw">pop</span> <span class="kw">ebp</span>           <span class="co">; so: restore caller's ebp from stack [esp]</span></a>
<a class="sourceLine" id="cb35-4" title="4"><span class="kw">ret</span>               <span class="co">; return to caller</span></a></code></pre></div>
<h4 id="in-the-caller">In the Caller</h4>
<p>To call a function <code>target</code> that takes <code>N</code> parameters:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode nasm"><code class="sourceCode nasm"><a class="sourceLine" id="cb36-1" title="1"><span class="kw">push</span> arg_N        <span class="co">; push last arg first ...</span></a>
<a class="sourceLine" id="cb36-2" title="2">...</a>
<a class="sourceLine" id="cb36-3" title="3"><span class="kw">push</span> arg_<span class="dv">2</span>        <span class="co">; then the second ...</span></a>
<a class="sourceLine" id="cb36-4" title="4"><span class="kw">push</span> arg_<span class="dv">1</span>        <span class="co">; finally the first</span></a>
<a class="sourceLine" id="cb36-5" title="5"><span class="kw">call</span> target       <span class="co">; make the call (which puts return addr on stack)</span></a>
<a class="sourceLine" id="cb36-6" title="6"><span class="kw">add</span> <span class="kw">esp</span>, <span class="dv">4</span>*N      <span class="co">; now we are back: &quot;clear&quot; args by adding 4*numArgs</span></a></code></pre></div>
<p><strong>NOTE:</strong> If you are compiling on MacOS, you must respect the <a href="http://www.fabiensanglard.net/macosxassembly/index.php">16-Byte Stack Alignment Invariant</a></p>
<h3 id="fixed-strategy-by-example">Fixed Strategy By Example</h3>
<p>Lets implement the above in a simple file <code>tests/output/int-check.s</code></p>
<p>TODO</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode nasm"><code class="sourceCode nasm"><a class="sourceLine" id="cb37-1" title="1"><span class="kw">section</span> .text</a>
<a class="sourceLine" id="cb37-2" title="2"><span class="kw">extern</span> error</a>
<a class="sourceLine" id="cb37-3" title="3"><span class="kw">extern</span> print</a>
<a class="sourceLine" id="cb37-4" title="4"><span class="kw">global</span> our_code_starts_here</a>
<a class="sourceLine" id="cb37-5" title="5"><span class="fu">our_code_starts_here:</span></a>
<a class="sourceLine" id="cb37-6" title="6">  <span class="kw">push</span> <span class="kw">ebp</span></a>
<a class="sourceLine" id="cb37-7" title="7">  <span class="kw">mov</span> <span class="kw">ebp</span>, <span class="kw">esp</span></a>
<a class="sourceLine" id="cb37-8" title="8">  <span class="kw">sub</span> <span class="kw">esp</span>, <span class="dv">0</span>                <span class="co">; 0 local variables here</span></a>
<a class="sourceLine" id="cb37-9" title="9">  <span class="kw">mov</span> <span class="kw">eax</span>, <span class="dv">1</span>                <span class="co">; not a valid number</span></a>
<a class="sourceLine" id="cb37-10" title="10">  <span class="kw">mov</span> <span class="kw">ebx</span>, <span class="kw">eax</span>              <span class="co">; copy into ebx register</span></a>
<a class="sourceLine" id="cb37-11" title="11">  <span class="kw">and</span> <span class="kw">ebx</span><span class="bn">, 0x00000001       </span><span class="co">; extract lsb</span></a>
<a class="sourceLine" id="cb37-12" title="12">  <span class="kw">cmp</span> <span class="kw">ebx</span>, <span class="dv">0</span>                <span class="co">; check if lsb equals 0</span></a>
<a class="sourceLine" id="cb37-13" title="13">  <span class="kw">jne</span> error_non_number      </a>
<a class="sourceLine" id="cb37-14" title="14">  <span class="kw">mov</span> <span class="kw">esp</span>, <span class="kw">ebp</span></a>
<a class="sourceLine" id="cb37-15" title="15">  <span class="kw">pop</span> <span class="kw">ebp</span>  </a>
<a class="sourceLine" id="cb37-16" title="16">  <span class="kw">ret</span></a>
<a class="sourceLine" id="cb37-17" title="17"><span class="fu">error_non_number:</span></a>
<a class="sourceLine" id="cb37-18" title="18">  <span class="kw">push</span> <span class="kw">eax</span></a>
<a class="sourceLine" id="cb37-19" title="19">  <span class="kw">push</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb37-20" title="20">  <span class="kw">call</span> error</a></code></pre></div>
<p>Aha, now the above works!</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb38-1" title="1"><span class="fu">make</span> tests/output/int-check.result</a>
<a class="sourceLine" id="cb38-2" title="2"><span class="ex">...</span> expected number but got ...</a></code></pre></div>
<p><strong>Q:</strong> What NEW thing does our compiler need to compute?</p>
<p><strong>Hint:</strong> Why do we <code>sub esp, 0</code> above?</p>
<h3 id="types-2">Types</h3>
<p>Lets implement the above strategy.</p>
<p>To do so, we need a new data type for run-time types:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb39-1" title="1"><span class="kw">data</span> <span class="dt">Ty</span> <span class="fu">=</span> <span class="dt">TNumber</span> <span class="fu">|</span> <span class="dt">TBoolean</span></a></code></pre></div>
<p>a new <code>Label</code> for the error</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb40-1" title="1"><span class="kw">data</span> <span class="dt">Label</span></a>
<a class="sourceLine" id="cb40-2" title="2">  <span class="fu">=</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb40-3" title="3">  <span class="fu">|</span> <span class="dt">TypeError</span> <span class="dt">Ty</span>        <span class="co">-- Type Error Labels</span></a>
<a class="sourceLine" id="cb40-4" title="4">  <span class="fu">|</span> <span class="dt">Builtin</span>   <span class="dt">Text</span>      <span class="co">-- Functions implemented in C</span></a></code></pre></div>
<p>and thats it.</p>
<h3 id="transforms-2">Transforms</h3>
<p>The compiler must generate code to:</p>
<ol type="1">
<li>Perform dynamic type checks,</li>
<li>Exit by calling <code>error</code> if a failure occurs,</li>
<li>Manage the stack per the convention above.</li>
</ol>
<h4 id="type-assertions">1. Type Assertions</h4>
<p>The key step in the implementation is to write a function</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb41-1" title="1"><span class="ot">assertType ::</span> <span class="dt">Env</span> <span class="ot">-&gt;</span> <span class="dt">IExp</span> <span class="ot">-&gt;</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> [<span class="dt">Instruction</span>]</a>
<a class="sourceLine" id="cb41-2" title="2">assertType env v ty</a>
<a class="sourceLine" id="cb41-3" title="3">  <span class="fu">=</span> [ <span class="dt">IMov</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v)</a>
<a class="sourceLine" id="cb41-4" title="4">    , <span class="dt">IMov</span> (<span class="dt">Reg</span> <span class="dt">EBX</span>) (<span class="dt">Reg</span> <span class="dt">EAX</span>)</a>
<a class="sourceLine" id="cb41-5" title="5">    , <span class="dt">IAnd</span> (<span class="dt">Reg</span> <span class="dt">EBX</span>) (<span class="dt">HexConst</span> <span class="bn">0x00000001</span>)</a>
<a class="sourceLine" id="cb41-6" title="6">    , <span class="dt">ICmp</span> (<span class="dt">Reg</span> <span class="dt">EBX</span>) (typeTag  ty)</a>
<a class="sourceLine" id="cb41-7" title="7">    , <span class="dt">IJne</span> (<span class="dt">TypeError</span> ty)</a>
<a class="sourceLine" id="cb41-8" title="8">    ]</a></code></pre></div>
<p>where <code>typeTag</code> is:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb42-1" title="1"><span class="ot">typeTag ::</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Arg</span></a>
<a class="sourceLine" id="cb42-2" title="2">typeTag <span class="dt">TNumber</span>  <span class="fu">=</span> <span class="dt">HexConst</span> <span class="bn">0x00000000</span></a>
<a class="sourceLine" id="cb42-3" title="3">typeTag <span class="dt">TBoolean</span> <span class="fu">=</span> <span class="dt">HexConst</span> <span class="bn">0x00000001</span>  </a></code></pre></div>
<p>You can now splice <code>assertType</code> prior to doing the actual computations, e.g.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb43-1" title="1"><span class="ot">compilePrim2 ::</span> <span class="dt">Env</span> <span class="ot">-&gt;</span> <span class="dt">Prim2</span> <span class="ot">-&gt;</span> <span class="dt">ImmE</span> <span class="ot">-&gt;</span> <span class="dt">ImmE</span> <span class="ot">-&gt;</span> [<span class="dt">Instruction</span>]</a>
<a class="sourceLine" id="cb43-2" title="2">compilePrim2 env <span class="dt">Plus</span> v1 v2   <span class="fu">=</span> assertType env v1 <span class="dt">TNumber</span></a>
<a class="sourceLine" id="cb43-3" title="3">                             <span class="fu">++</span> assertType env v2 <span class="dt">TNumber</span>  </a>
<a class="sourceLine" id="cb43-4" title="4">                             <span class="fu">++</span> [ <span class="dt">IMov</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v1)</a>
<a class="sourceLine" id="cb43-5" title="5">                                , <span class="dt">IAdd</span> (<span class="dt">Reg</span> <span class="dt">EAX</span>) (immArg env v2)</a>
<a class="sourceLine" id="cb43-6" title="6">                                ]</a></code></pre></div>
<h4 id="errors">2. Errors</h4>
<p>We must also add code <em>at</em> the <code>TypeError TNumber</code> and <code>TypeError TBoolean</code> labels.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb44-1" title="1"><span class="ot">errorHandler ::</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Asm</span></a>
<a class="sourceLine" id="cb44-2" title="2">errorHandler t <span class="fu">=</span></a>
<a class="sourceLine" id="cb44-3" title="3">  [ <span class="dt">ILabel</span>   (<span class="dt">TypeError</span> t)        <span class="co">-- the expected-number error</span></a>
<a class="sourceLine" id="cb44-4" title="4">  ,   <span class="dt">IPush</span>  (<span class="dt">Reg</span> <span class="dt">EAX</span>)            <span class="co">-- push the second &quot;value&quot; param first,</span></a>
<a class="sourceLine" id="cb44-5" title="5">  ,   <span class="dt">IPush</span>  (ecode t)            <span class="co">-- then the first  &quot;code&quot; param,</span></a>
<a class="sourceLine" id="cb44-6" title="6">  ,   <span class="dt">ICall</span>  (<span class="dt">Builtin</span> <span class="st">&quot;error&quot;</span>)    <span class="co">-- call the run-time's &quot;error&quot; function.  </span></a>
<a class="sourceLine" id="cb44-7" title="7">  ]</a>
<a class="sourceLine" id="cb44-8" title="8"></a>
<a class="sourceLine" id="cb44-9" title="9"><span class="ot">ecode ::</span> <span class="dt">Ty</span> <span class="ot">-&gt;</span> <span class="dt">Arg</span>   </a>
<a class="sourceLine" id="cb44-10" title="10">ecode <span class="dt">TNumber</span>  <span class="fu">=</span> <span class="dt">Const</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb44-11" title="11">ecode <span class="dt">TBoolean</span> <span class="fu">=</span> <span class="dt">Const</span> <span class="dv">1</span></a></code></pre></div>
<h4 id="stack-management">4. Stack Management</h4>
<p><strong>Local Variables</strong></p>
<p>First, <a href="#calling-convention">note that</a> the local variables live at offsets from <code>ebp</code>, so lets update</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb45-1" title="1"><span class="ot">immArg ::</span> <span class="dt">Env</span> <span class="ot">-&gt;</span> <span class="dt">ImmTag</span> <span class="ot">-&gt;</span> <span class="dt">Arg</span></a>
<a class="sourceLine" id="cb45-2" title="2">immArg _   (<span class="dt">Number</span> n _) <span class="fu">=</span> <span class="dt">Const</span> n</a>
<a class="sourceLine" id="cb45-3" title="3">immArg env (<span class="dt">Var</span>    x _) <span class="fu">=</span> <span class="dt">RegOffset</span> <span class="dt">EBP</span> i</a>
<a class="sourceLine" id="cb45-4" title="4">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb45-5" title="5">    i                   <span class="fu">=</span> fromMaybe err (<span class="fu">lookup</span> x env)</a>
<a class="sourceLine" id="cb45-6" title="6">    err                 <span class="fu">=</span> <span class="fu">error</span> (printf <span class="st">&quot;Error: Variable '%s' is unbound&quot;</span> x)</a></code></pre></div>
<p><strong>Maintaining <code>esp</code> and <code>ebp</code></strong></p>
<p>We need to make sure that <em>all</em> our code respects <a href="#calling-convention">the C calling convention.</a>.</p>
<p>To do so, just <em>wrap</em> the generated code, with instructions to save and restore <code>ebp</code> and <code>esp</code></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb46-1" title="1"><span class="ot">compileBody ::</span> <span class="dt">AnfTagE</span> <span class="ot">-&gt;</span> <span class="dt">Asm</span></a>
<a class="sourceLine" id="cb46-2" title="2">compileBody e <span class="fu">=</span> entryCode e</a>
<a class="sourceLine" id="cb46-3" title="3">             <span class="fu">++</span> compileEnv emptyEnv e</a>
<a class="sourceLine" id="cb46-4" title="4">             <span class="fu">++</span> exitCode e</a>
<a class="sourceLine" id="cb46-5" title="5"></a>
<a class="sourceLine" id="cb46-6" title="6"><span class="ot">entryCode ::</span> <span class="dt">AnfTagE</span> <span class="ot">-&gt;</span> <span class="dt">Asm</span></a>
<a class="sourceLine" id="cb46-7" title="7">entryCode e <span class="fu">=</span> [ <span class="dt">IPush</span> (<span class="dt">Reg</span> <span class="dt">EBP</span>)</a>
<a class="sourceLine" id="cb46-8" title="8">              , <span class="dt">IMov</span>  (<span class="dt">Reg</span> <span class="dt">EBP</span>) (<span class="dt">Reg</span> <span class="dt">ESP</span>)</a>
<a class="sourceLine" id="cb46-9" title="9">              , <span class="dt">ISub</span>  (<span class="dt">Reg</span> <span class="dt">ESP</span>) (<span class="dt">Const</span> <span class="dv">4</span> <span class="fu">*</span> n)</a>
<a class="sourceLine" id="cb46-10" title="10">              ]</a>
<a class="sourceLine" id="cb46-11" title="11">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb46-12" title="12">    n       <span class="fu">=</span> countVars e</a>
<a class="sourceLine" id="cb46-13" title="13"></a>
<a class="sourceLine" id="cb46-14" title="14"><span class="ot">exitCode ::</span> <span class="dt">AnfTagE</span> <span class="ot">-&gt;</span> <span class="dt">Asm</span></a>
<a class="sourceLine" id="cb46-15" title="15">exitCode <span class="fu">=</span> [ <span class="dt">IMove</span> (<span class="dt">Reg</span> <span class="dt">ESP</span>) (<span class="dt">Reg</span> <span class="dt">EBP</span>)</a>
<a class="sourceLine" id="cb46-16" title="16">           , <span class="dt">IPop</span>  (<span class="dt">Reg</span> <span class="dt">EBP</span>)</a>
<a class="sourceLine" id="cb46-17" title="17">           , <span class="dt">IRet</span></a>
<a class="sourceLine" id="cb46-18" title="18">           ]</a></code></pre></div>
<p><strong>Q:</strong> But how shall we compute <code>countVars</code>?</p>
<p>Here’s a shady kludge:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb47-1" title="1"><span class="ot">countVars ::</span> <span class="dt">AnfTagE</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb47-2" title="2">countVars <span class="fu">=</span> <span class="dv">100</span></a></code></pre></div>
<p>Obviously a sleazy hack (<em>why?</em>), but lets use it to <em>test everything else</em>; then we can fix it.</p>
<h2 id="computing-the-size-of-the-stack">5. Computing the Size of the Stack</h2>
<p>Ok, now that everything (else) seems to work, lets work out:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb48-1" title="1"><span class="ot">countVars ::</span> <span class="dt">AnfTagE</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></a></code></pre></div>
<p>Finding the <em>exact</em> answer is <strong>undecidable</strong> in general (CSE 105), i.e. is <em>impossible</em> to compute.</p>
<p>However, it is easy to find an <em>overapproximate</em> heuristic, i.e.</p>
<ul>
<li><p>a value guaranteed to be <em>larger</em> than the than the max size,</p></li>
<li><p>and which is reasonable in practice.</p></li>
</ul>
<p>As usual, lets see if we can work out a heuristic by example.</p>
<h3 id="quiz-3">QUIZ</h3>
<p>How many stack slots/vars are needed for the following program?</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb49-1" title="1"><span class="dv">1</span> <span class="fu">+</span> <span class="dv">2</span></a></code></pre></div>
<ol type="1">
<li><code>0</code></li>
<li><code>1</code></li>
<li><code>2</code></li>
</ol>
<h3 id="quiz-4">QUIZ</h3>
<p>How many stack slots/vars are needed for the following program?</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb50-1" title="1"><span class="kw">let</span> x <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb50-2" title="2">  , y <span class="fu">=</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb50-3" title="3">  , z <span class="fu">=</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb50-4" title="4"><span class="kw">in</span></a>
<a class="sourceLine" id="cb50-5" title="5">  x <span class="fu">+</span> y <span class="fu">+</span> z</a></code></pre></div>
<ol type="1">
<li><code>0</code></li>
<li><code>1</code></li>
<li><code>2</code></li>
<li><code>3</code></li>
<li><code>4</code></li>
</ol>
<h3 id="quiz-5">QUIZ</h3>
<p>How many stack slots/vars are needed for the following program?</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb51-1" title="1"><span class="kw">if</span> true<span class="fu">:</span></a>
<a class="sourceLine" id="cb51-2" title="2">  <span class="kw">let</span> x <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb51-3" title="3">    , y <span class="fu">=</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb51-4" title="4">    , z <span class="fu">=</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb51-5" title="5">  <span class="kw">in</span></a>
<a class="sourceLine" id="cb51-6" title="6">    x <span class="fu">+</span> y <span class="fu">+</span> z</a>
<a class="sourceLine" id="cb51-7" title="7"><span class="kw">else</span><span class="fu">:</span></a>
<a class="sourceLine" id="cb51-8" title="8">  <span class="dv">0</span></a></code></pre></div>
<ol type="1">
<li><code>0</code></li>
<li><code>1</code></li>
<li><code>2</code></li>
<li><code>3</code></li>
<li><code>4</code></li>
</ol>
<h3 id="quiz-6">QUIZ</h3>
<p>How many stack slots/vars are needed for the following program?</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb52-1" title="1"><span class="kw">let</span> x <span class="fu">=</span></a>
<a class="sourceLine" id="cb52-2" title="2">  <span class="kw">let</span> y <span class="fu">=</span></a>
<a class="sourceLine" id="cb52-3" title="3">    <span class="kw">let</span> z <span class="fu">=</span> <span class="dv">3</span>  </a>
<a class="sourceLine" id="cb52-4" title="4">    <span class="kw">in</span> z <span class="fu">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb52-5" title="5">  <span class="kw">in</span> y <span class="fu">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb52-6" title="6"><span class="kw">in</span> x <span class="fu">+</span> <span class="dv">1</span></a></code></pre></div>
<ol type="1">
<li><code>0</code></li>
<li><code>1</code></li>
<li><code>2</code></li>
<li><code>3</code></li>
<li><code>4</code></li>
</ol>
<h3 id="strategy-2">Strategy</h3>
<p>Let <code>countVars e</code> be:</p>
<ul>
<li><p>The <em>maximum</em> number of let-binds in scope at any point <em>inside</em> <code>e</code>, i.e.</p></li>
<li><p>The <em>maximum</em> size of the <code>Env</code> when compiling <code>e</code></p></li>
</ul>
<p>Lets work it out on a case-by-case basis:</p>
<ul>
<li><strong>Immediate values</strong> like <code>Number</code> or <code>Var</code>
<ul>
<li>are compiled <em>without pushing</em> anything onto the <code>Env</code></li>
<li>i.e. <code>countVars</code> = 0</li>
</ul></li>
<li><strong>Binary Operations</strong> like <code>Prim2 o v1 v2</code> take immediate values,
<ul>
<li>are compiled <em>without pushing</em> anything onto the <code>Env</code></li>
<li>i.e. <code>countVars</code> = 0</li>
</ul></li>
<li><strong>Branches</strong> like <code>If v e1 e2</code> can go either way
<ul>
<li>can’t tell at compile-time</li>
<li>i.e. worst-case is larger of <code>countVars e1</code> and <code>countVars e2</code></li>
</ul></li>
<li><strong>Let-bindings</strong> like <code>Let x e1 e2</code> require
<ul>
<li>evaluating <code>e1</code> and</li>
<li><em>pushing</em> the result onto the stack and then evaluating <code>e2</code></li>
<li>i.e. larger of <code>countVars e1</code> and <code>1 + countVars e2</code></li>
</ul></li>
</ul>
<h3 id="implementation">Implementation</h3>
<p>We can implement the above a simple recursive function:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb53-1" title="1"><span class="ot">countVars ::</span> <span class="dt">AnfTagE</span> <span class="ot">-&gt;</span> <span class="dt">Int</span>  </a>
<a class="sourceLine" id="cb53-2" title="2">countVars (<span class="dt">If</span> v e1 e2)  <span class="fu">=</span> <span class="fu">max</span> (countVars e1) (countVars e2)</a>
<a class="sourceLine" id="cb53-3" title="3">countVars (<span class="dt">Let</span> x e1 e2) <span class="fu">=</span> <span class="fu">max</span> (countVars e1) (<span class="dv">1</span> <span class="fu">+</span> countVars e2)</a>
<a class="sourceLine" id="cb53-4" title="4">countVars _             <span class="fu">=</span> <span class="dv">0</span></a></code></pre></div>
<h3 id="naive-heuristic-is-naive">Naive Heuristic is Naive</h3>
<p>The above method is quite simplistic. For example, consider the expression:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb54-1" title="1"><span class="kw">let</span> x <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb54-2" title="2">  , y <span class="fu">=</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb54-3" title="3">  , z <span class="fu">=</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb54-4" title="4"><span class="kw">in</span></a>
<a class="sourceLine" id="cb54-5" title="5">    <span class="dv">0</span></a></code></pre></div>
<p><code>countVars</code> would tell us that we need to allocate <code>3</code> stack spaces but clearly <em>none</em> of the variables are actually used.</p>
<p>Will revisit this problem later, when looking at optimizations.</p>
<h2 id="recap">Recap</h2>
<p>We just saw how to add support for</p>
<ul>
<li><strong>Multiple datatypes</strong> (<code>number</code> and <code>boolean</code>)</li>
<li><strong>Calling</strong> external functions</li>
</ul>
<p>and in doing so, learned about</p>
<ul>
<li><strong>Tagged Representations</strong></li>
<li><strong>Calling Conventions</strong></li>
</ul>
<p>To get some practice, in your assignment, you will add:</p>
<ol type="1">
<li>Dynamic Checks for Arithmetic Overflows (see the <code>jo</code> and <code>jno</code> operations)</li>
<li>A Primitive <code>print</code> operation implemented by a function in the <code>c</code> run-time.</li>
</ol>
<p>And next, we’ll see how to easily add <strong>user-defined functions</strong>.</p>
        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
